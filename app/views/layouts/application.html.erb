<!DOCTYPE html>
<html class="cool-scrollbar">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dreambox</title>
    <%= csrf_meta_tags %>

    <%= stylesheet_link_tag    'application', media: 'all', 'data-turbolinks-track': 'reload' %>
    <%if Rails.env.production?%>
      <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <%else # development | test %>
      <%=javascript_include_tag 'vue'%>
    <%end%>
    <%= javascript_include_tag 'application', 'data-turbolinks-track': 'reload' %>
    <script type="text/javascript" charset="utf-8">
Vue.config.productionTip = Vue.config.devtools = false;
const Routes = {
    getAllClients:    companyId => `/companies/${companyId}/clients.json`,
    getAllServices:   (companyId) => `/companies/${companyId}/services.json`,
    addNewClient:     companyId => `/companies/${companyId}/clients.json`,
    addNewService:    companyId => `/companies/${companyId}/services.json`,
    removeClient:     (companyId, clientId) => `/companies/${companyId}/clients/${clientId}.json`,
    removeService:    (companyId, serviceId) => `/companies/${companyId}/services/${serviceId}.json`,
    signIn:           () => '/auth/sign_in?return_url=' + encodeURIComponent(location.href),
    clientInfoWindow: () => '/windows/client-info',
    serviceInfoWindow:() => '/windows/service-info',
    addClientWindow:  () => '/windows/add-client',
    addServiceWindow: () => '/windows/add-service',
};
const AUTHENTICITY_TOKEN = document.querySelector('meta[name=csrf-token]').content
    </script>
  </head>

  <body data-params="<%=params.to_json%>" class="home">

    <header>
      <div class="panel-logo">
        <a class="logo" href="/">
          <img src="/images/lflflf.png">
        </a>
        <div class="info-logo">
          <div class="biz-logo">БИЗНЕС</div>
          <% if signed_in? and Client.exists? id: current_user.people_id %>
            <div class="company-logo btn-show-list">
              <div class="name-company" style="float: left;"><%= @current_company.name %></div>

              <div class="panel-show" style="width: 260px;">
                <div style="background-color: #e6eaed; cursor: default;">
                    <div style="float: left;">
                      <div style="font-size: 15px; font-weight: 600;"><%= Company.find(@current_people.company_id).name %></div>
                      <div class="img-input" style="width: 100%; font-size: 13px;">
                        <%= image_tag s3_image(@current_people.avatar), style: 'width: 10px; height: 10px; margin: 0 5px;' %>
                        <%= @current_people.last_name %> <%= @current_people.first_name %>
                      </div>
                      <div style="font-size: 12px; color: darkgrey; margin-top: 5px;">
                        <% work_director = Work.where people_id: @current_people.id, position_work: 'director' %>
                        <% work_administrator = Work.where people_id: @current_people.id, position_work: 'administrator' %>
                        <%if work_director.present?%>
                          - Директор
                        <%end %>                    
                        <%if work_administrator.present? %>
                          - Администратор
                        <%end %>
                        <%if (@current_people.role.to_i & Client::Role::CLIENT) > 0 %>
                          - Клиент
                        <%end %>
                      </div>
                    </div>
                  </div>
                <% @people_user = Client.where(user_id: current_user.id).where.not(id: @current_people.id) %>
                <% @people_user.each do |p| %>
                  <% work_director = Work.where people_id: p.id, position_work: 'director' %>
                  <% work_administrator = Work.where people_id: p.id, position_work: 'administrator' %>
                  <%= link_to role_person_path(p.id), method: :post do %>
                    <div style="float: left;">
                      <div style="font-size: 15px; font-weight: 600;"><%= Company.find(p.company_id).name %></div>
                      <div class="img-input" style="width: 100%; font-size: 13px;">
                        <%= image_tag s3_image(p.avatar), style: 'width: 10px; height: 10px; margin: 0 5px;' %>
                        <%= p.last_name %> <%= p.first_name %>
                      </div>
                      <div style="font-size: 12px; color: darkgrey; margin-top: 5px;">
                        <%if work_director.present?%>
                          - Директор
                        <%end %>                    
                        <%if work_administrator.present? %>
                          - Администратор
                        <%end %>
                        <%if (p.role.to_i & Client::Role::CLIENT) > 0 %>
                          - Клиент
                        <%end %>
                      </div>
                    </div>
                  <% end %>
                <% end %>
                <%= link_to '+Добавить новою компанию', new_company_path, class: "add-discount" %>
              </div>
            </div>
          <% end %>
        </div>

      </div>

      <%if signed_in? %>
        <%=link_to persons_profile_path, class: "panel-account" do %>
          <div class="account-name">
            <%= current_user.first_name %> <%= current_user.last_name %>
          </div>
          <%= image_tag s3_image(current_user.avatar), class: 'account-avatar' %>
        <%end%>
      <%end%>

    </header>

    <nav class="menu">
      <div class="item-menu icon-menu"></div>
      <div style="width: 17px;
    height: 17px;
    padding: 10px;
    margin: 3px 12px;
    border-radius: 50%;
    float: left;
    background: white;
    color: black;"><ion-icon style="width: 100%; height: 100%;" name="add"></ion-icon></div>
      <a href="#" class="item-menu icon-client"></a>
      <a href="#" class="item-menu icon-company"></a>
      <a href="#" class="item-menu icon-finance"></a>
    </nav>
    
    <content id="app">
        
      <div class="panel-list">
        <div class="search">
          <img src="/images/search.png" class="search-icon">
          <input v-on:input="sendQuery('search', $event.target.value)" name="search" class="search-field" type="text" :placeholder="titleInput" value="<%= params[:search] %>" id="search" autocomplete="off" />

          <div class="reset-search">
            <ion-icon name="close"></ion-icon>
          </div>

          <div class="search-info">
            <div class="item-search"></div>
          </div>
        </div>

        <div v-if="loadComplete == false" class="loading"><img src="images/loading.gif" /></div>
        <div v-if="loadComplete == true" class="container-list cool-scrollbar">
          <ul v-if="searchClients.length > 0" class="list">
            <li v-for="client in searchClients" @click="openCardClient(client.id)" class="item-list" :key="client.id">
              <img class="avatar-listt" src="/resources/no-image-available.png">
              <div class="left-content">
                <div class="name-content">{{ client.last_name }} {{ client.first_name }} {{ client.patronymic }}</div>
                <span class="desc-content">- UCMAS</span>
              </div>
              <div class="right-content">
                <span class="debt">0.0 ₽</span>
              </div>
            </li>
          </ul>
          <div v-if="searchClients.length <= 0" class="loading">
            <div>
              <img src="images/crying.png" style="width: 40px; margin: auto; margin-bottom: 10px;" />
              <div>Ничего не найдено</div>
            </div>
          </div>
        </div>
      </div>

      <div class="panels-content hide-scrollbar">

        <div>

        <div class="panel-content">
          <div class="indecators">
            <div @click="sendQuery('clients', 'current')" class="indecator">
              <div>32</div>
              <span>Текущие клиенты</span>
            </div>
            <div @click="sendQuery('clients', 'debtors')" class="indecator">
              <div>14</div>
              <span>Должники</span>
            </div>
            <div @click="sendQuery('clients', 'total')" class="indecator">
              <div>255</div>
              <span>Все клиенты</span>
            </div>
          </div>

          <div class="panel-footer">
            <div>
              <div>{{ searchClients.length }}</div>
              <div>кол-во в списке</div>
            </div>
            <div>
              <div>10000</div>
              <div>долг</div>
            </div>
          </div>
        </div>


        <div v-if="client.length != 0" class="">
          <div class="panel-content">
            <div class="panel-info">

              <div class="basic-info">
                <img v-if="client.length != 0" class="ava" src="/resources/no-image-available.png">
                <div class="basic-info__container">
                  <div class="basic-info__container__content">
                    <div class="name-panel">{{client.last_name}} {{client.first_name}}</div>
                    <div style="font-size: 13px; color: #444444;">{{client.patronymic}} {{client.phone_number}}</div>
                  </div>
                </div>

                <div v-on:click="showTotalInfo = !showTotalInfo" class="click-compact" v-bind:class="{ active: showTotalInfo }"><img src="images/_ionicons_svg_ios-arrow-down.svg"></div>
              </div>

              <div v-if="showTotalInfo" class="total-info">

                <div v-if="client.birthday != null" class="item-info">
                  <div class="title-item-info">Дата рождения</div>
                  <div class="content-item-info">{{client.birthday}}</div>
                </div>
                <div v-if="client.sex != null" class="item-info">
                  <div class="title-item-info">Пол</div>
                  <div class="content-item-info">{{client.sex}}</div>
                </div>

                <div class="title-info">Информация о родителе</div>

                <div v-if="client.birthday != null" class="item-info">
                  <div class="title-item-info">Дата рождения</div>
                  <div class="content-item-info">{{client.birthday}}</div>
                </div>
                <div v-if="client.sex != null" class="item-info">
                  <div class="title-item-info">Пол</div>
                  <div class="content-item-info">{{client.sex}}</div>
                </div>

              </div>

            </div>
            <div class="panel-panel">

              <div v-if="openPanelAdd == null">
                <div class="amount">
                  <div class="amount-price">14000.0 ₽</div>
                  <div class="amount-name">Оплатил</div>
                </div>

                <div class="amount" style="color: #ff7375;">
                  <div class="amount-price">6000.0 ₽</div>
                  <div class="amount-name">Долг</div>
                </div>

                <div class="btn-show-panel btn-show-list">
                  <div class="panel-show" style="left: auto; right: 10px;">
                    <a href="/clients/199/edit">Редактировать</a>
                  </div>
                  <ion-icon style="width: 100%; height: 100%;" name="more"></ion-icon>
                </div>
                <div @click="openPanelAdd = 'addRecordClient'" class="btn-add-panel">
                    <ion-icon style="width: 100%; height: 100%;" name="add" role="img" class="hydrated" aria-label="add"></ion-icon>
                </div>
              </div>


              <div v-if="openPanelAdd == 'addRecordClient'" class="panel-add">

                <div @click="openPanelAdd = null" class="btn-back new-btn">
                  <ion-icon name="arrow-back"></ion-icon>
                </div>

                <div class="panel-form">
                  <section class="">
                    <h2 class="panel-form__title">Запись клиента в группу</h2>
                    <div v-if="selectRecordsClient.length != 0" >
                      <input type="hidden" id="authenticity_token" value="<%=form_authenticity_token%>">
                      <div v-for="record in selectRecordsClient" class="item-panel">
                        <div class="item-panel__basic-info">
                          <div class="left-item-panel">{{ record.name }}</div>
                          <div class="right-item-panel">
                            <button @click="attachRecord(record.id)" :value="record.id" class="btn-subscribe">записать</button>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div v-else>
                      <div class="no-record">Нет групп для записи</div>
                    </div>
                    <div class="btn-add-group">+ Создать группу</div>
                  </section>

<!--                   <div class="finput focus">
                    <label class="finput-label">Записи</label>
                    <select class="finput-input" v-model="idAddRecordClient">
                      <option value="" selected disabled>Выберите один из вариантов</option>
                      <option v-for="record in selectRecordsClient" :value="record.id">{{ record.name }}</option>
                    </select>
                  </div>

                  <div class="btns-confirm">
                    <div @click="attachRecord" class="btn-confirm new-btn">
                      <ion-icon name="checkmark"></ion-icon>
                    </div>
                    <div @click="openPanelAdd = null" class="btn-close-panel new-btn">
                      <ion-icon name="close"></ion-icon>
                    </div>
                  </div> -->
                </div>

              </div>

            </div>
          </div>

          <div class="panel-content">
            <div class="panel-header">
              <div class="title-panel">Оказываемые услуги</div>
              <div class="show-panel">Показать все</div>
            </div>
            <div class="list-panel">
              <div v-for="record in recordsClient" class="item-panel active">

                <div>
                  <div class="left-item-panel">{{ record.name }}</div>
                  <div class="right-item-panel">нет абонемента</div>
                </div>

                <div class="item-panel__total-info">

                  <div class="total-info__service">
                    <span class="service__item">UCMAS</span>
                  </div>

                  <div class="unsubscribe" rel="nofollow" data-method="delete">Отписать</div>

                  <div class="info-about-subsc">Осталось оплатить <span class="red">4000.0 ₽</span></div>

                  <div class="subscriptions">
                    <div class="subscription">
                      <div class="data-subscriptions">
                        от 01 <span>августа</span> 2018 до 31 <span>августа</span> 2018
                      </div> 
                    </div>
                    <div class="subscription">
                      <div class="data-subscriptions">
                        от 01 <span>августа</span> 2018 до 31 <span>августа</span> 2018
                      </div> 
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </div>

          <section class='panel-content'>
            <div class="panel-header">
              <div class="title-panel">Транзакции</div>
              <div class="show-panel">Показать все</div>
            </div>
            <div class="list-panel">
              <div class="item-panel">
                <div class="left-item-panel">Оплата за абонемент от 23 октября...</div>
                <div class="right-item-panel green">6000.0 ₽</div>
              </div>
              <div class="item-panel">
                <div class="left-item-panel">Оплата за абонемент от 23 октября...</div>
                <div class="right-item-panel red">- 6000.0 ₽</div>
              </div>
              <div class="item-panel">
                <div class="left-item-panel">Оплата за абонемент от 23 октября...</div>
                <div class="right-item-panel red">- 6000.0 ₽</div>
              </div>
            </div>
          </section>

          <div class="panel-content">
            <div class="panel-header">
              <div class="title-panel">Скидки и коррекция цены</div>
              <div class="show-panel">Показать все</div>
            </div>
            <div class="list-panel">
              <div class="item-panel">
                <div class="left-item-panel">Оплата за абонемент от 23 октября...</div>
                <div class="right-item-panel green">6000.0 ₽</div>
              </div>
            </div>
          </div>

        </div>


        <% if params[:record].present? %>
          <div class="panel-content">
            Группа
          </div>
        <% end %>

        </div>
      </div>

    </content>
    

    <%yield%>
    
    <div class="back-background"></div>

    <script src="https://unpkg.com/ionicons@4.2.4/dist/ionicons.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.16/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.10/lodash.min.js"></script>
<!-- 

 -->

    <script type="text/javascript">
      var authToken = document.getElementById("authenticity_token").value
      var valueInput = document.getElementById("search").value
      var lastId = null;

      new Vue ({
        el: '#app',
        data: {
          clientsCompany: [],
          recordsCompany: [],
          titleInput: "Поиск клиентов", // будет подставляться название группы
          searchClients: [],
          client: [],
          selectRecordsClient: [],
          recordsClient: [],
          loadComplete: false,
          showTotalInfo: false,
          idAddRecordClient: "",
          openPanelAdd: null
        },
        methods: {
          openCardClient(value) {

            getClient = _.find(this.clientsCompany, {id:value});
            this.client = getClient;

            url = window.location.href;
            newUrl = updateURLParameter(url, 'client', value);
            history.pushState('', 'Клиент', newUrl);


            $.get(
              '/get_select_records_client.json', 
              {
                idClient: value
              },
              selectRecordsClient => this.selectRecordsClient = selectRecordsClient
            );

            $.get(
              '/get_records_client.json', 
              {
                idClient: value
              },
              recordsClient => this.recordsClient = recordsClient
            );

          },
          sendQuery(type, value) {
            url = window.location.href;
            newUrl = updateURLParameter(url, type, value);


            this.clientsQuery(newUrl);
          },
          clientsQuery(url) {

            urlHash = new URL(url);
            clientQuery = urlHash.searchParams.get("search");
            typeOfClients = urlHash.searchParams.get("clients");

            arrayClientQuery = validSpaces(clientQuery).split(' ');

            clearTimeout(lastId)
            this.loadComplete = false;


            lastId = setTimeout(() => {
              $.get(
                '/get_clients.json', 
                {
                  typeOfClients: typeOfClients,
                  lastNameClients: arrayClientQuery[0],
                  firstNameClients: arrayClientQuery[1],
                  patronymicClients: arrayClientQuery[2]
                // ,
                // record: 29
                },
                searchClients => {
                  this.searchClients = searchClients;
                  this.loadComplete = true;
                  history.pushState('', clientQuery, url);
                }
              );

            }, 600);

          },
          attachRecord(id) {
            let {idAddRecordClient, client} = this
            getRecord = _.find(this.recordsCompany, {id:id});

            $.ajax('/records_clients', {
              method: 'POST',
              data: {
                authenticity_token: authToken,
                record_client: {
                  record_id: id,
                  client_id: client.id,
                }
              },
              error: e => console.warn('error', e)
            }).done(newRecordClient => {
              newRecordClient = {id: getRecord.id, name: getRecord.name};
              this.selectRecordsClient.pop(id);
              this.recordsClient.push(newRecordClient);
            })
          }
        },
        created() {
          this.sendQuery('search', valueInput);

          $.ajax({
            url: '/get_clients.json',
            success: clientsCompany => {
              this.clientsCompany = clientsCompany

              urlHash = new URL(window.location.href);
              id = urlHash.searchParams.get("client");
              if(id != null) {
                id = parseInt(id, 10);
                this.openCardClient(id);
              }
            }
          });

          $.get(
            '/get_records.json',
            recordsCompany => this.recordsCompany = recordsCompany
          );
        }
      });
    </script>
  </body>
</html>
